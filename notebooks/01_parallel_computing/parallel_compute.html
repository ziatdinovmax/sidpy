

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Speed up computations with parallel_compute() &mdash; sidpy 0.0.3 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Visualization" href="../02_visualization/index.html" />
    <link rel="prev" title="Parallel computing" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> sidpy
          

          
          </a>

          
            
            
              <div class="version">
                0.0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">SIDpy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../external_guides.html">Tutorials on Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute.html">Guidelines for Contribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../matlab.html">Upgrading from Matlab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact us</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/sidpy.html">sidpy</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../00_basic_usage/index.html">Basic usage</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Parallel computing</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Speed up computations with parallel_compute()</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Example-scientific-problem">Example scientific problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Load-the-dataset">Load the dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#The-operation">The operation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Testing-the-function">Testing the function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Serial-computing">Serial computing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sidpy.proc.comp_utils.parallel_compute()">sidpy.proc.comp_utils.parallel_compute()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Compare-the-results">Compare the results</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Simplifying-the-function">Simplifying the function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#More-cores!">More cores!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Scalability">Scalability</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../02_visualization/index.html">Visualization</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">sidpy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Parallel computing</a> &raquo;</li>
        
      <li>Speed up computations with parallel_compute()</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/notebooks/01_parallel_computing/parallel_compute.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="section" id="Speed-up-computations-with-parallel_compute()">
<h1>Speed up computations with parallel_compute()<a class="headerlink" href="#Speed-up-computations-with-parallel_compute()" title="Permalink to this headline">¶</a></h1>
<p><strong>Suhas Somnath, Chris R. Smith</strong></p>
<p>9/8/2017</p>
<p><strong>This document will demonstrate how ``sidpy.proc.comp_utils.parallel_compute()`` can significantly speed up data processing by using all available CPU cores in a computer</strong></p>
<div class="section" id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline">¶</a></h2>
<p>Quite often, we need to perform the same operation on every single component in our data. One of the most popular examples is functional fitting applied to spectra collected at each location on a grid. While, the operation itself may not take very long, computing this operation thousands of times, once per location, using a single CPU core can take a long time to complete. Most personal computers today come with at least two cores, and in many cases, each of these cores is represented via two
logical cores, thereby summing to a total of at least four cores. Thus, it is prudent to make use of these unused cores whenever possible. Fortunately, there are a few python packages that facilitate the efficient use of all CPU cores with minimal modifications to the existing code.</p>
<p><code class="docutils literal notranslate"><span class="pre">sidpy.proc.comp_utils.parallel_compute()</span></code> is a very handy function that simplifies parallel computation significantly to a <strong>single function call</strong> and will be discussed in this document.</p>
</div>
<div class="section" id="Example-scientific-problem">
<h2>Example scientific problem<a class="headerlink" href="#Example-scientific-problem" title="Permalink to this headline">¶</a></h2>
<p>For this example, we will be working with a <code class="docutils literal notranslate"><span class="pre">Band</span> <span class="pre">Excitation</span> <span class="pre">Piezoresponse</span> <span class="pre">Force</span> <span class="pre">Microscopy</span> <span class="pre">(BE-PFM)</span></code> imaging dataset acquired from advanced atomic force microscopes. In this dataset, a spectra was collected for each position in a two dimensional grid of spatial locations. Thus, this is a three dimensional dataset that has been flattened to a two dimensional matrix in accordance with <strong>Universal Spectroscopy and Imaging Data (USID)</strong> model.</p>
<p>Each spectra in this dataset is expected to have a single peak. The goal is to find the positions of the peaks in each spectra. Clearly, the operation of finding the peak in one spectra is independent of the same operation on another spectra. Thus, we could in theory divide the dataset in to N parts and use N CPU cores to compute the results much faster than it would take a single core to compute the results. There is an important caveat to this statement and it will be discussed at the end of
this document.</p>
<p><strong>Here, we will learn how to fit the thousands of spectra using all available cores on a computer.</strong> Note, that this is applicable only for a single CPU. Please refer to another advanced example for multi-CPU computing.</p>
<div class="alert alert-info"><h4><p>Note</p>
</h4><p><p>In order to run this document on your own computer, you will need to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1. Download the document as a Jupyter notebook using the link at the bottom of this page.
2. Save the contents of `this python file &lt;https://github.com/pycroscopy/sidpy/blob/master/examples/proc/supporting_docs/peak_finding.py&gt;`_ as ``peak_finding.py`` in the
   same folder as the notebook from step 1.&lt;/p&gt;&lt;/div&gt;
</pre></div>
</div>
<p>Ensure python 3 compatibility:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="c1"># The package for accessing files in directories, etc.:</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Warning package in case something goes wrong</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">import</span> <span class="nn">subprocess</span>


<span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="n">package</span><span class="p">):</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;pip&quot;</span><span class="p">,</span> <span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="n">package</span><span class="p">])</span>
<span class="c1"># Package for downloading online files:</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># This package is not part of anaconda and may need to be installed.</span>
    <span class="kn">import</span> <span class="nn">wget</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;wget not found.  Will install with pip.&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">pip</span>
    <span class="n">install</span><span class="p">(</span><span class="n">wget</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">wget</span>

<span class="c1"># The mathematical computation package:</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># The package used for creating and manipulating HDF5 files:</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="c1"># Packages for plotting:</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Parallel computation library:</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">joblib</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;joblib not found.  Will install with pip.&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">pip</span>
    <span class="n">install</span><span class="p">(</span><span class="s1">&#39;joblib&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">joblib</span>

<span class="c1"># Timing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># A handy python utility that allows us to preconfigure parts of a function</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="c1"># Finally import sidpy:</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sidpy.proc.comp_utils</span> <span class="kn">import</span> <span class="n">parallel_compute</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;sidpy not found.  Will install with pip.&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">pip</span>
    <span class="n">install</span><span class="p">(</span><span class="s1">&#39;sidpy&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">sidpy.proc.comp_utils</span> <span class="kn">import</span> <span class="n">parallel_compute</span>

<span class="c1"># import the scientific function:</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./supporting_docs/&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">peak_finding</span> <span class="kn">import</span> <span class="n">find_all_peaks</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ModuleNotFoundError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-c04ac15a58a0&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     57</span> <span class="ansi-green-fg">import</span> sys
<span class="ansi-green-intense-fg ansi-bold">     58</span> sys<span class="ansi-blue-fg">.</span>path<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;./supporting_docs/&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 59</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> peak_finding <span class="ansi-green-fg">import</span> find_all_peaks

<span class="ansi-red-fg">ModuleNotFoundError</span>: No module named &#39;peak_finding&#39;
</pre></div></div>
</div>
</div>
<div class="section" id="Load-the-dataset">
<h2>Load the dataset<a class="headerlink" href="#Load-the-dataset" title="Permalink to this headline">¶</a></h2>
<p>In order to demonstrate parallel computing, we will be using a real experimental dataset that is available on the pyUSID GitHub project. First, lets download this file from Github:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">h5_path</span> <span class="o">=</span> <span class="s1">&#39;temp.h5&#39;</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/pycroscopy/pyUSID/master/data/BELine_0004.h5&#39;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">h5_path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">h5_path</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">h5_path</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now, lets open this HDF5 file. The focus of this example is not on the data storage or arrangement but rather on demonstrating parallel computation so lets dive straight into the main dataset that requires fitting of the spectra:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Open the file in read-only mode</span>
<span class="n">h5_file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">h5_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="c1"># Get handle to the the raw data</span>
<span class="n">h5_meas_grp</span> <span class="o">=</span> <span class="n">h5_file</span><span class="p">[</span><span class="s1">&#39;Measurement_000&#39;</span><span class="p">]</span>

<span class="c1"># Accessing the dataset of interest:</span>
<span class="n">h5_main</span> <span class="o">=</span> <span class="n">h5_meas_grp</span><span class="p">[</span><span class="s1">&#39;Channel_000/Raw_Data&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The main dataset:</span><span class="se">\n</span><span class="s1">------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">h5_main</span><span class="p">)</span>

<span class="n">num_cols</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">cores_vec</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">times_vec</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

The main dataset:
------------------------------------
&lt;HDF5 dataset &#34;Raw_Data&#34;: shape (16384, 119), type &#34;&lt;c8&#34;&gt;
</pre></div></div>
</div>
</div>
<div class="section" id="The-operation">
<h2>The operation<a class="headerlink" href="#The-operation" title="Permalink to this headline">¶</a></h2>
<p>The scipy package has a very handy function called <em>find_peaks_cwt()</em> that facilitates the search for one or more peaks in a spectrum. We will be using a function called <em>find_all_peaks()</em> that uses <em>find_peaks_cwt()</em>. For the purposes of this example, we do not be concerned with how this function works. All we need to know is that this function takes 3 inputs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">vector</span></code> - a 1D array containing the spectra at a single location</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">width_bounds</span></code> - something like [20, 50] that instructs the function to look for peaks that are 20-50 data-points wide. The function will look for a peak with width of 20, then again for a peak of width - 21 and so on.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_steps</span></code> - The number of steps within the possible widths [20, 50], that the search must be performed</p></li>
</ul>
<p>The function has one output:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">peak_indices</span></code> - an array of the positions at which peaks were found.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<p>def find_all_peaks(vector, width_bounds, num_steps=20, **kwargs): “”” This is the function that will be mapped by multiprocess. This is a wrapper around the scipy function. It uses a parameter - wavelet_widths that is configured outside this function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Parameters</span>
<span class="o">----------</span>
<span class="n">vector</span> <span class="p">:</span> <span class="mi">1</span><span class="n">D</span> <span class="n">numpy</span> <span class="n">array</span>
    <span class="n">Feature</span> <span class="n">vector</span> <span class="n">containing</span> <span class="n">peaks</span>
<span class="n">width_bounds</span> <span class="p">:</span> <span class="nb">tuple</span> <span class="o">/</span> <span class="nb">list</span> <span class="o">/</span> <span class="n">iterable</span>
    <span class="n">Min</span> <span class="ow">and</span> <span class="nb">max</span> <span class="k">for</span> <span class="n">the</span> <span class="n">size</span> <span class="n">of</span> <span class="n">the</span> <span class="n">window</span>
<span class="n">num_steps</span> <span class="p">:</span> <span class="n">uint</span><span class="p">,</span> <span class="p">(</span><span class="n">optional</span><span class="p">)</span><span class="o">.</span> <span class="n">Default</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">Number</span> <span class="n">of</span> <span class="n">different</span> <span class="n">peak</span> <span class="n">widths</span> <span class="n">to</span> <span class="n">search</span>

<span class="n">Returns</span>
<span class="o">-------</span>
<span class="n">peak_indices</span> <span class="p">:</span> <span class="nb">list</span>
    <span class="n">List</span> <span class="n">of</span> <span class="n">indices</span> <span class="n">of</span> <span class="n">peaks</span> <span class="n">within</span> <span class="n">the</span> <span class="n">prescribed</span> <span class="n">peak</span> <span class="n">widths</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># The below numpy array is used to configure the returned function wpeaks</span>
<span class="s2">wavelet_widths = np.linspace(width_bounds[0], width_bounds[1], num_steps)</span>

<span class="s2">peak_indices = find_peaks_cwt(np.abs(vector), wavelet_widths, **kwargs)</span>

<span class="s2">return peak_indices</span>
</pre></div>
</div>
</div>
<div class="section" id="Testing-the-function">
<h2>Testing the function<a class="headerlink" href="#Testing-the-function" title="Permalink to this headline">¶</a></h2>
<p>Let’s see what the operation on an example spectra returns.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span> <span class="o">=</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">19</span>
<span class="n">pixel_ind</span> <span class="o">=</span> <span class="n">col_ind</span> <span class="o">+</span> <span class="n">row_ind</span> <span class="o">*</span> <span class="n">num_cols</span>
<span class="n">spectra</span> <span class="o">=</span> <span class="n">h5_main</span><span class="p">[</span><span class="n">pixel_ind</span><span class="p">]</span>

<span class="n">peak_inds</span> <span class="o">=</span> <span class="n">find_all_peaks</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span> <span class="n">num_steps</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">axis</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectra</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">peak_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectra</span><span class="p">))]);</span>
<span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;find_all_peaks found peaks at index: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peak_inds</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-bcc6021ab475&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span> spectra <span class="ansi-blue-fg">=</span> h5_main<span class="ansi-blue-fg">[</span>pixel_ind<span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">      4</span>
<span class="ansi-green-fg">----&gt; 5</span><span class="ansi-red-fg"> </span>peak_inds <span class="ansi-blue-fg">=</span> find_all_peaks<span class="ansi-blue-fg">(</span>spectra<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">20</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">60</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> num_steps<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">30</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      6</span>
<span class="ansi-green-intense-fg ansi-bold">      7</span> fig<span class="ansi-blue-fg">,</span> axis <span class="ansi-blue-fg">=</span> plt<span class="ansi-blue-fg">.</span>subplots<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;find_all_peaks&#39; is not defined
</pre></div></div>
</div>
<p>Before we apply the function to the entire dataset, lets load the dataset to memory so that file-loading time is not a factor when comparing the times for serial and parallel computing times:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">h5_main</span><span class="p">[()]</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<div class="admonition-title fa fa-exclamation-circle"><h4></div><p>Note</p>
</h4><p><p>This documentation is being generated automatically by a computer in the cloud whose workload cannot be controlled or predicted. Therefore, the computational times reported in this document may not be consistent and can even be contradictory. For best results, we recommend that download and run this document as a jupyter notebook.</p>
</p></div>
</div>
<div class="section" id="Serial-computing">
<h2>Serial computing<a class="headerlink" href="#Serial-computing" title="Permalink to this headline">¶</a></h2>
<p>A single call to the function does not take substantial time. However, performing the same operation on each of the <code class="docutils literal notranslate"><span class="pre">16,384</span></code> pixels sequentially can take substantial time. The simplest way to find all peak positions is to simply loop over each position in the dataset:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">serial_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<span class="n">t_0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">vector</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">:</span>
    <span class="n">serial_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">find_all_peaks</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span> <span class="n">num_steps</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span>
<span class="n">times_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t_0</span><span class="p">)</span>
<span class="n">cores_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Serial computation took&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">times_vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39; seconds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-3d6dd23c2ba8&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span> t_0 <span class="ansi-blue-fg">=</span> time<span class="ansi-blue-fg">.</span>time<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      4</span> <span class="ansi-green-fg">for</span> vector <span class="ansi-green-fg">in</span> raw_data<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">----&gt; 5</span><span class="ansi-red-fg">     </span>serial_results<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>find_all_peaks<span class="ansi-blue-fg">(</span>vector<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">20</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">60</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> num_steps<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">30</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      6</span> times_vec<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>time<span class="ansi-blue-fg">.</span>time<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">-</span>t_0<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      7</span> cores_vec<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;find_all_peaks&#39; is not defined
</pre></div></div>
</div>
</div>
<div class="section" id="sidpy.proc.comp_utils.parallel_compute()">
<h2>sidpy.proc.comp_utils.parallel_compute()<a class="headerlink" href="#sidpy.proc.comp_utils.parallel_compute()" title="Permalink to this headline">¶</a></h2>
<p>There are several libraries that can utilize multiple CPU cores to perform the same computation in parallel. Popular examples are <code class="docutils literal notranslate"><span class="pre">Multiprocessing</span></code>, <code class="docutils literal notranslate"><span class="pre">Mutiprocess</span></code>, <code class="docutils literal notranslate"><span class="pre">Dask</span></code>, <code class="docutils literal notranslate"><span class="pre">Joblib</span></code> etc. Each of these has their own strengths and weaknesses. Some of them have painful caveats such as the inability to perform the parallel computation within a jupyter notebook. In order to lower the barrier to parallel computation, we have developed a very handy function called
<code class="docutils literal notranslate"><span class="pre">sidpy.proc.comp_utils.parallel_compute()</span></code> that simplifies the process to a single function call.</p>
<p>It is a lot <strong>more straightforward</strong> to provide the arguments and keyword arguments of the function that needs to be applied to the entire dataset. Furthermore, this function intelligently assigns the number of CPU cores for the parallel computation based on the size of the dataset and the computational complexity of the unit computation. For instance, it scales down the number of cores for small datasets if each computation is short. It also ensures that 1-2 cores fewer than all available cores
are used by default so that the user can continue using their computer for other purposes while the computation runs.</p>
<p>Lets apply this <code class="docutils literal notranslate"><span class="pre">parallel_compute</span></code> to this problem:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cpu_cores</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">args</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">]]</span>
<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">}</span>

<span class="n">t_0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># Execute the parallel computation</span>
<span class="n">parallel_results</span> <span class="o">=</span> <span class="n">parallel_compute</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">find_all_peaks</span><span class="p">,</span>
                                         <span class="n">cores</span><span class="o">=</span><span class="n">cpu_cores</span><span class="p">,</span> <span class="n">func_args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                                         <span class="n">func_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
                                         <span class="n">joblib_backend</span><span class="o">=</span><span class="s1">&#39;multiprocessing&#39;</span><span class="p">)</span>

<span class="n">cores_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpu_cores</span><span class="p">)</span>
<span class="n">times_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t_0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parallel computation with </span><span class="si">{}</span><span class="s1"> cores took </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cpu_cores</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">times_vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-ad7c0f471083&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      6</span>
<span class="ansi-green-intense-fg ansi-bold">      7</span> <span class="ansi-red-fg"># Execute the parallel computation</span>
<span class="ansi-green-fg">----&gt; 8</span><span class="ansi-red-fg"> parallel_results = parallel_compute(raw_data, find_all_peaks,
</span><span class="ansi-green-intense-fg ansi-bold">      9</span>                                          cores<span class="ansi-blue-fg">=</span>cpu_cores<span class="ansi-blue-fg">,</span> func_args<span class="ansi-blue-fg">=</span>args<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     10</span>                                          func_kwargs<span class="ansi-blue-fg">=</span>kwargs<span class="ansi-blue-fg">,</span>

<span class="ansi-red-fg">NameError</span>: name &#39;find_all_peaks&#39; is not defined
</pre></div></div>
</div>
</div>
<div class="section" id="Compare-the-results">
<h2>Compare the results<a class="headerlink" href="#Compare-the-results" title="Permalink to this headline">¶</a></h2>
<p>By comparing the run-times for the two approaches, we see that the parallel computation is substantially faster than the serial computation. Note that the numbers will differ between computers. Also, the computation was performed on a relatively small dataset for illustrative purposes. The benefits of using such parallel computation will be far more apparent for much larger datasets.</p>
<p>Let’s compare the results from both the serial and parallel methods to ensure they give the same results:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Result from serial computation: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">serial_results</span><span class="p">[</span><span class="n">pixel_ind</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Result from parallel computation: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parallel_results</span><span class="p">[</span><span class="n">pixel_ind</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">IndexError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-f95e8e46678b&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Result from serial computation: {}&#39;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>serial_results<span class="ansi-blue-fg">[</span>pixel_ind<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Result from parallel computation: {}&#39;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>parallel_results<span class="ansi-blue-fg">[</span>pixel_ind<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">IndexError</span>: list index out of range
</pre></div></div>
</div>
</div>
<div class="section" id="Simplifying-the-function">
<h2>Simplifying the function<a class="headerlink" href="#Simplifying-the-function" title="Permalink to this headline">¶</a></h2>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">width_bounds</span></code> and <code class="docutils literal notranslate"><span class="pre">num_steps</span></code> arguments will not be changed from one pixel to another. It would be great if we didn’t have to keep track of these constant arguments. We can use a very handy python tool called <code class="docutils literal notranslate"><span class="pre">partial()</span></code> to do just this. Below, all we are doing is creating a new function that always passes our preferred values for <code class="docutils literal notranslate"><span class="pre">width_bounds</span></code> and <code class="docutils literal notranslate"><span class="pre">num_steps</span></code> arguments to find_all_peaks. While it may seem like this is unimportant, it is very convenient when setting
up the parallel computing:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">find_peaks</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">find_all_peaks</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">width_bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-2e5d5c2638c5&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>find_peaks <span class="ansi-blue-fg">=</span> partial<span class="ansi-blue-fg">(</span>find_all_peaks<span class="ansi-blue-fg">,</span> num_steps<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">30</span><span class="ansi-blue-fg">,</span> width_bounds<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">20</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">60</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;find_all_peaks&#39; is not defined
</pre></div></div>
</div>
<p>Notice that even though <code class="docutils literal notranslate"><span class="pre">width_bounds</span></code> is an argument, it needs to be specified as though it were a keyword argument like <code class="docutils literal notranslate"><span class="pre">num_steps</span></code>. Let’s try calling our simplified function, <code class="docutils literal notranslate"><span class="pre">find_peaks()</span></code> to make sure that it results in the same peak index for the aforementioned chosen spectra:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;find_peaks found peaks at index: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">h5_main</span><span class="p">[</span><span class="n">pixel_ind</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-c65a00b392bd&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;find_peaks found peaks at index: {}&#39;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>find_peaks<span class="ansi-blue-fg">(</span>h5_main<span class="ansi-blue-fg">[</span>pixel_ind<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;find_peaks&#39; is not defined
</pre></div></div>
</div>
</div>
<div class="section" id="More-cores!">
<h2>More cores!<a class="headerlink" href="#More-cores!" title="Permalink to this headline">¶</a></h2>
<p>Lets use <code class="docutils literal notranslate"><span class="pre">find_peaks()</span></code> instead of <code class="docutils literal notranslate"><span class="pre">find_all_peaks</span></code> on the entire dataset but increase the number of cores to 3. Note that we do not need to specify <code class="docutils literal notranslate"><span class="pre">func_kwargs</span></code> anymore. Also note that this is a very simple function and the benefits of <code class="docutils literal notranslate"><span class="pre">partial()</span></code> will be greater for more complex problems.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cpu_cores</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">t_0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># Execute the parallel computation</span>
<span class="n">parallel_results</span> <span class="o">=</span> <span class="n">parallel_compute</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">find_peaks</span><span class="p">,</span>
                                         <span class="n">cores</span><span class="o">=</span><span class="n">cpu_cores</span><span class="p">,</span>
                                         <span class="n">joblib_backend</span><span class="o">=</span><span class="s1">&#39;multiprocessing&#39;</span><span class="p">)</span>

<span class="n">cores_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpu_cores</span><span class="p">)</span>
<span class="n">times_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t_0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parallel computation with </span><span class="si">{}</span><span class="s1"> cores took </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cpu_cores</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">times_vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-c25ddf058c42&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      4</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span> <span class="ansi-red-fg"># Execute the parallel computation</span>
<span class="ansi-green-fg">----&gt; 6</span><span class="ansi-red-fg"> parallel_results = parallel_compute(raw_data, find_peaks,
</span><span class="ansi-green-intense-fg ansi-bold">      7</span>                                          cores<span class="ansi-blue-fg">=</span>cpu_cores<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">      8</span>                                          joblib_backend=&#39;multiprocessing&#39;)

<span class="ansi-red-fg">NameError</span>: name &#39;find_peaks&#39; is not defined
</pre></div></div>
</div>
</div>
<div class="section" id="Scalability">
<h2>Scalability<a class="headerlink" href="#Scalability" title="Permalink to this headline">¶</a></h2>
<p>Now lets see how the computational time relates to the number of cores. Depending on your computer (and what was running on your computer along with this computation), you are likely to see diminishing benefits of additional cores beyond 2 cores for this specific problem in the plot below. This is because the dataset is relatively small and each peak-finding operation is relatively quick. The overhead of adding additional cores quickly outweighs the speedup in distributing the work among
multiple CPU cores.</p>
<div class="alert alert-info"><h4><p>Note</p>
</h4><p><p>This documentation is being generated automatically by a computer in the cloud whose workload cannot be controlled or predicted. Therefore, the computational times reported in this document may not be consistent and can even be contradictory. For best results, we recommend that download and run this document as a jupyter notebook.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">If</span> <span class="n">everything</span> <span class="n">ran</span> <span class="n">correctly</span><span class="p">,</span> <span class="n">you</span> <span class="n">should</span> <span class="n">see</span> <span class="n">the</span> <span class="n">computational</span> <span class="n">time</span> <span class="n">decrease</span> <span class="n">substantially</span> <span class="kn">from</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">2</span> <span class="n">cores</span> <span class="n">but</span>
<span class="n">the</span> <span class="n">decrease</span> <span class="kn">from</span> <span class="mi">2</span> <span class="n">to</span> <span class="mi">3</span> <span class="ow">or</span> <span class="mi">3</span> <span class="n">to</span> <span class="mi">4</span> <span class="n">cores</span> <span class="n">should</span> <span class="n">be</span> <span class="n">minimal</span> <span class="ow">or</span> <span class="n">negligible</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>
<span class="n">axis</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cores_vec</span><span class="p">,</span> <span class="n">times_vec</span><span class="p">)</span>
<span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;CPU cores&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Compute time (sec)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_01_parallel_computing_parallel_compute_25_0.png" src="../../_images/notebooks_01_parallel_computing_parallel_compute_25_0.png" />
</div>
</div>
<p>Best practices for parallel computing ————————————–</p>
<p>While it may seem tempting to do everything in parallel, it is important to be aware of some of the trade-offs and best-practices for parallel computing (multiple CPU cores) when compared to traditional serial computing (single CPU core):</p>
<ul class="simple">
<li><p>There is noticeable time overhead involved with setting up each compute worker (CPU core in this case). For very simple or small computations, this overhead may outweigh the speed-up gained with using multiple cores.</p></li>
<li><p>Parallelizing computations that read and write to files at each iteration may be actually be noticeably <em>slower</em> than serial computation since the cores will compete for rights to read and write to the file(s) and these input/output operations are by far the slowest components of the workflow. Instead, it makes sense to read large amounts of data from the necessary files once, perform the computation, and then write to the files once after all the computation is complete. In fact, this is
what we automatically do in the <code class="docutils literal notranslate"><span class="pre">Process</span></code> class in pyUSID or pyNSID. Please see <code class="docutils literal notranslate"><span class="pre">another</span> <span class="pre">example</span> <span class="pre">&lt;./plot_process.html&gt;</span></code>_ on how to write a Process class to formalize data processing.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">parallel_compute()</span></code> will revert to serial processing when called within the message passing interface (MPI) context in a high-performance computing (HPC) cluster. Due to conflicts between MPI, numpy, and joblib, it is recommended to use a pure MPI approach for computing instead of the MPI + OpenMP (joblib) paradigm.</p>
</div>
<p>Cleaning up <sub>:sub:</sub><sub>~``</sub>~<sub>~</sub> Lets not forget to close and delete the temporarily downloaded file:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">h5_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">h5_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../02_visualization/index.html" class="btn btn-neutral float-right" title="Visualization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Parallel computing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Suhas Somnath, Gerd Duscher, and contributors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>